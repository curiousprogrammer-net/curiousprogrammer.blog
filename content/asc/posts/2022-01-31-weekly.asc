{
:date "2022-01-31"
:title "Weekly Bits & Pieces 01/2022 (24.1. - 30.1.)"
:layout :post
:tags  ["weekly-bits" "aws" "clojure" "dns"]
}

:toc:
:toclevels: 4

## Clojure

### Quick links:

* https://clojureverse.org/t/donut-system-your-new-favourite-component-library-by-daniel-higginbotham/8578 [Donut.system: your new favourite component library? (by Daniel Higginbotham)]
* https://www.juxt.pro/blog/new-clojure-iteration[The new Clojure "iteration" function]
* https://clojurians.slack.com/archives/C03S1KBA2/p1643214628154700[Is there any performance penalty to using vars instead of function references]
** Ben Sless: only matters when they're on a hot path or very fast. If they take microseconds or more to execute I wouldn't be bothered by it


### PurelyFunctional.tv newsletter - domain modeling series

This is not strictly Clojure-specific but I started reading through
a bunch of posts about domain modeling by Eric Normand.
It starts with https://purelyfunctional.tv/issues/purelyfunctional-tv-newsletter-446-the-art-of-domain-modeling/[PF.tv newsletter # 446]
and he's still publishing new posts.

There's a lot of great content and insights.
My favorite one, so far, has been
https://purelyfunctional.tv/issues/purelyfunctional-tv-newsletter-447-domain-model-fit/[447: Domain model fit]
where he talks about _reference back to reality_ and, as an example, misuse of the *Decorator pattern*.
It also links to two former episodes which talks about the Decorator pattern in more detail:

* https://purelyfunctional.tv/issues/purelyfunctional-tv-newsletter-407-two-layers-of-design/[407: two layers of design]
* https://purelyfunctional.tv/issues/purelyfunctional-tv-newsletter-412-use-and-abuse-of-the-decorator-pattern/[412: use and abuse of the decorator pattern]

### _nippy_ serialization issues with joda DateTime 

We store user session data in Redis via https://github.com/ptaoussanis/nippy[_nippy_].

After upgrading the library to a newer version, we found a serialization issue in one particular use case:

[source]
----
clojure.lang.ExceptionInfo: Cannot thaw object: `taoensso.nippy/*thaw-serializable-allowlist*` check failed.
This is a security feature.
See `*thaw-serializable-allowlist*` docstring or https://github.com/ptaoussanis/nippy/issues/130 for details!
class-name: "org.joda.time.DateTime"
----

The solution was to, as they suggest, whitelist all the classes in the `org.joda.time` package:

[source,clojure]
----
  ;; saving joda DateTime instances in the session requires custom allow list for nippy
  ;; see https://github.com/ptaoussanis/nippy/issues/130
  (alter-var-root #'taoensso.nippy/*thaw-serializable-allowlist*
                  (fn [allowlist] (conj allowlist "org.joda.time.*")))
----

Notice that the default allowlist contains for example `java.time` classes:

[source,clojure]
----
* 
taoensso.nippy/*thaw-serializable-allowlist*
#{"java.lang.NullPointerException"
...
  "java.time.LocalTime"
----

See the https://github.com/ptaoussanis/nippy/issues/130[nippy issue] for  more details.


## Java / JVM

## Regular expressions - character classes

In the https://inside.java/2021/09/14/podcast-019/[Inside Java podcast], I learned about https://dev.java/, a nice resource for java developers.

One of the resources is about regular expressions and in particular
https://dev.java/learn/regex/character-classes/[character classes].
I was well aware of the stuff like `[a-zA-Z]` but usage of Interesections via `&&` was new to me.

E.g. this means _"a through z, and not m through p: [a-lq-z] (subtraction)"_.
[source]
----
[a-z&&[^m-p]]
----

### Java and DNS caching

In https://jvns.ca/blog/2022/01/15/some-ways-dns-can-break/[Some ways DNS can break],
Julia Evans talks about various ways DNS might cause you headaches.

One of them is "Java caching DNS records forever".
This _only_ applies to situations when _SecurityManager_ is enabled (not mentioned in the article)
or when you explicitly tell Java to do so.

However, it made me explore java DNS caching in more detail.
I found a great article
https://maheshsenniappan.medium.com/host-name-resolution-in-java-80301fea465a[Host name resolution in Java]
exploring the topic in depth.

Below I summarize a few important things I have learned.


#### If you don't customize it, the default values for caching / TTLS in Java are:

* https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/sun/net/InetAddressCachePolicy.java#L49[30 seconds for successful results]
* 10 seconds for negative caching
** Note that https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/net/doc-files/net-properties.html#networkaddress.cache.negative.ttl[javadoc]
says, that `networkaddress.cache.ttl`'s default is forever if a security manager is enabled and _implementation-specific_ otherwise.
The OpenJDK implementation I linked uses the default 30 seconds.

#### `networkaddress.cache.ttl` and `networkaddress.cache.negative.ttl` are java _security_ properties:

That means you cannot set them with `-D` like this:

[source]
----
# this doesn't work!
java -Dnetworkaddress.cache.ttl=5 ...
----

Instead, you have to set it in the `java.security` policy file.
Notice also how the default for the negative cache ttl is set in the policy file,
not in the source code as with the "positive" cache ttl:

[source]
----
networkaddress.cache.ttl=5

# this is the default value - if you delete this line,
# the default value set in the JDK code is 0
networkaddress.cache.negative.ttl=10
----

See also https://stackoverflow.com/questions/1256556/how-to-make-java-honor-the-dns-caching-timeout


#### Java calls native function `getaddrinfo` (on Linux)

This apparently
https://jvns.ca/blog/2022/01/15/some-ways-dns-can-break/#problem-round-robin-dns-doesn-t-work-with-getaddrinfo[doesn't work with round robin DNS load balancing technique]
because `getaddrinfo` sorts the IP responses it receives.


## AWS & Cloud

### RDS upgrade through terraform - replaced instance, missing tables/data




### Cloudonaut - Comparing API Gateways on AWS

A very useful resource from the Cloudonaut guys about 5 different types of API gateways offered by AWS.

It's a bit older but quite useful: https://cloudonaut.io/comparing-api-gateways-on-aws/

The 5 types include:

* API Gateway REST API - most mature, supports user/tenant based throttling
* API Gateway HTTP API
* API Gateway WebSocket API
* API Gateway AppSync (GraphQL)
* Application Load Balancer - cost effective and very simple to use but not able to transform requests/responses


## Books

### Api Security in Action

TODO: add the mindmap from Chapter 4?


### Practical Monitoring

### 50 Quick Ideas to improve your user stories



## Writing




## MISC

### Software bill of materials

This is an interesting area of focus in the security and open source community.
I recently stumbled upon this topic when listening to the podcast with David A. Wheeler: 
https://www.devseccon.com/the-secure-developer-podcast/ep-91-open-source-security-with-dr-david-a-wheeler[Open Source Security with Dr. David A. Wheeler]

We also got a question about it from one of our https://codescene.com/[CodeScene] customers.

Here's a useful resource explaning the idea: https://fossa.com/blog/software-bill-of-materials-formats-use-cases-tools/

* A software bill of materials is an inventory of all software components (proprietary and open source), open source licenses, and dependencies in a given product. 
* A software bill of materials (SBOM) provides visibility into the software supply chain and any license compliance, security, and quality risks that may exist.



## Links

A quick recap of some of the links mentioned in this post:




